<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GG.AI Labs Whatsapp API</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="px-4 py-4">
  <div class="ui container">

    <div class="main-header">
      <h1 class="ui header center aligned">
        <span class="title-container">
          <i class="whatsapp icon"></i> Bem-vindo(a) a GG.AI Labs Whatsapp API
        </span>
      </h1>
    </div>

    <div class="ui segment hidden" id="connectstatus"></div>

    <div class="ui horizontal divider"> Sessao </div>
    <div class="ui three column stackable grid cards">
      <div class="green card" style="cursor: pointer;" id="authWidget">
        <div class="content"><a class="ui teal right ribbon label">Sessao</a>
          <div class="header">Autenticar</div>
          <div class="description"> Insira ou altere o token de autenticacao. </div>
        </div>
      </div>
 
      <div class="green card hidden" style="cursor: pointer;" id="loginQR">
        <div class="content"><a class="ui teal right ribbon label">Sessao</a>
          <div class="header">Entrar com QR</div>
          <div class="description"> Escaneie o codigo QR para acessar todos os recursos da API.</div>
        </div>
      </div>
      <div class="green card hidden" style="cursor: pointer;" id="loginCode">
        <div class="content"><a class="ui teal right ribbon label">Sessao</a>
          <div class="header">Entrar com Codigo de Pareamento</div>
          <div class="description"> Informe seu codigo de pareamento para entrar e acessar seus dispositivos.</div>
        </div>
      </div>
      <div class="green card hidden" style="cursor: pointer;" id="logoutWidget">
        <div class="content"><a class="ui teal right ribbon label">Sessao</a>
          <div class="header">Sair</div>
          <div class="description">Encerra a conexao com os servidores do WhatsApp e finaliza a sessao.</div>
        </div>
      </div>
    </div>

    <div class="ui horizontal divider widget"> Webhook </div>
    <div class="ui three column stackable grid cards">
      <div class="green card hidden widget" style="cursor: pointer;" id="setWebhook">
        <div class="content"><a class="ui green right ribbon label">Webhook</a>
          <div class="header">Configurar Webhook</div>
          <div class="description"> Define o webhook a ser chamado quando um evento ou mensagem for recebido.</div>
        </div>
      </div>
      <div class="green card hidden widget" style="cursor: pointer;" id="getWebhook">
        <div class="content"><a class="ui green right ribbon label">Webhook</a>
          <div class="header">Consultar Webhook</div>
          <div class="description"> Busca o webhook configurado no momento.</div>
        </div>
      </div>
      <div class="green card hidden widget" style="cursor: pointer;" id="deleteWebhook">
        <div class="content"><a class="ui green right ribbon label">Webhook</a>
          <div class="header">Remover Webhook</div>
          <div class="description"> Remove o webhook atual.</div>
        </div>
      </div>
    </div>

    <div class="ui horizontal divider widget"> Conversas </div>
    <div class="ui three column stackable grid cards">
      <div class="blue card hidden widget" style="cursor: pointer;" id="sendTextMessage">
        <div class="content"><a class="ui blue right ribbon label">Conversa</a>
          <div class="header">Enviar Mensagem de Texto</div>
          <div class="description"> Envia uma mensagem de texto.</div>
        </div>
      </div>
      <div class="blue card hidden widget" style="cursor: pointer;" id="deleteMessage">
        <div class="content"><a class="ui blue right ribbon label">Conversa</a>
          <div class="header">Apagar Mensagem</div>
          <div class="description"> Apaga uma mensagem enviada.</div>
        </div>
      </div>
    </div>

    <div class="ui horizontal divider widget"> Usuario </div>
    <div class="ui three column stackable grid cards">
      <div class="red card hidden widget" style="cursor: pointer;" id="userInfo">
        <div class="content"><a class="ui red right ribbon label">Usuario</a>
          <div class="header">Informacoes do Usuario</div>
          <div class="description"> Busca usuarios pelo numero de telefone.</div>
        </div>
      </div>
      <div class="red card hidden widget" style="cursor: pointer;" id="userAvatar">
        <div class="content"><a class="ui red right ribbon label">Usuario</a>
          <div class="header">Avatar do Usuario</div>
          <div class="description"> Obtem o avatar pelo numero de telefone.</div>
        </div>
      </div>
      <div class="red card hidden widget" style="cursor: pointer;" id="userContacts">
        <div class="content"><a class="ui red right ribbon label">Usuario</a>
          <div class="header">Listar Contatos</div>
          <div class="description"> Recupera todos os contatos.</div>
        </div>
      </div>
    </div>

    <!-- Modais de Sessao -->
    <div class="ui modal" id="modalAuthenticate"><i class="close icon"></i>
      <div class="header"> Informe o Token de Autenticacao </div>
      <div class="content">
        <div class="ui info danger hidden" id="invalidCredentials">
          <div class="ui icon message">
            <i class="exclamation triangle icon"></i>
            <div class="content">
              <div class="header" id="incorrectstatus">
                Token invalido
              </div>
            </div>
          </div>
        <hr>
        </div>
        <div class="ui form">
          <div class="field"><label>Token</label><input id='authtoken' type="text" placeholder="Token de Autenticacao"><small>Pressione Enter para enviar</small></div>
        </div>
      </div>
    </div>

    <div class="ui modal" id="modalLoginQR">
      <i class="close icon"></i>
      <div class="header">
        Entre no Whatsapp com Codigo QR
      </div>
      <div class="image content">
        <div class="ui medium image">
          <div id="qrContainer" class="text-center" style="width:275px;height:275px; border: 10px solid green; margin:auto;"></div>
        </div>
        <div class="description">
          <div class="ui header">Escaneie para conectar</div>
          <p>Abra Configuracoes > Dispositivos Conectados > Vincular Dispositivo</p>
        </div>
      </div>
    </div>
    
    <div class="ui modal" id="modalLoginWithCode"><i class="close icon"></i>
      <div class="header"> Obter Codigo de Pareamento </div>
      <div class="content">
        <div class="ui message info">
          <div class="header" id="pairInfo">Como parear?</div>
          <ol id="pairHelp">
            <li>Abra o seu Whatsapp</li>
            <li>Vincule um dispositivo</li>
            <li>Use o codigo de pareamento</li>
          </ol>
        </div>
        <div class="ui form">
          <div class="field"><label>Telefone</label><input id="pairphoneinput" type="text" placeholder="Digite seu numero de telefone"><small>Pressione Enter para enviar</small></div>
        </div>
      </div>
    </div>

    <!-- Modais de Webhook -->
    <div class="ui modal" id="modalGetWebhook"><i class="close icon"></i>
      <div class="header"> Webhook </div>
      <div class="content">
        <div class="ui message info hidden"></div>
        URL:
        <div class="ui message info" id="getWebhookContainer"></div>
        Eventos:
        <div class="ui message info" id="getWebhookContainerEvents"></div>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
      </div>
    </div>

    <div class="ui modal" id="modalSetWebhook"><i class="close icon"></i>
      <div class="header"> Webhook </div>
      <div class="content">
        <div class="ui form">
          <div class="field">
            <label>Eventos do Webhook</label>
            <select id="webhookEvents" class="ui fluid dropdown" multiple="">
              <option value="">Selecione os eventos</option>
              <option value="Message">Mensagem</option>
              <option value="ReadReceipt">Confirmacao de leitura</option>
              <option value="Presence">Presenca</option>
              <option value="HistorySync">Sincronizacao de historico</option>
              <option value="ChatPresence">Presenca no chat</option>
              <option value="All">Todos</option>
            </select>
          </div>
          <div class="field"><label>URL do Webhook</label><input id="webhookinput" type="text" placeholder="Digite a URL do webhook"></div>
        </div>
      <br>
      <br>
      <br>
      <br>
      <br>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
        <div class="ui positive right labeled icon button">Salvar<i class="checkmark icon"></i></div>
      </div>
    </div>

    <div class="ui modal" id="modalDeleteWebhook"><i class="close icon"></i>
      <div class="header"> Remover Webhook </div>
      <div class="content">
          Tem certeza?
      </div>
      <div class="actions">
        <div class="ui negative button">Nao</div>
        <div class="ui positive right labeled icon button">Sim</div>
      </div>
    </div>


    <!-- Modais de Usuario -->

    <div class="ui modal" id="modalUserInfo"><i class="close icon"></i>
      <div class="header"> Informacoes do Usuario </div>
      <div class="content">
        <div class="ui message info hidden" id="userInfoContainer"></div>
        <div class="ui form">
          <div class="field"><label>Telefone</label><input id="userinfoinput" type="text" placeholder="Digite o numero de telefone"></div>
        </div>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
        <div class="ui positive right labeled icon button">Buscar<i class="checkmark icon"></i></div>
      </div>
    </div>

    <div class="ui modal" id="modalUserAvatar"><i class="close icon"></i>
      <div class="header"> Avatar do Usuario </div>
      <div class="content">
        <div class="ui message info hidden" id="userAvatarContainer"></div>
        <div class="ui form">
          <div class="field"><label>Telefone</label><input id="useravatarinput" type="text" placeholder="Digite o numero de telefone"></div>
        </div>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
        <div class="ui positive right labeled icon button">Buscar<i class="checkmark icon"></i></div>
      </div>
    </div>

    <!-- Modais de Mensagens -->

    <div class="ui modal" id="modalSendTextMessage"><i class="close icon"></i>
      <div class="header"> Enviar Mensagem de Texto </div>
      <div class="content">
        <div class="ui message info hidden" id="sendMessageContainer"></div>
        <div class="ui form">
          <div class="field"><label>Telefone</label><input id="messagesendphone" type="text" placeholder="Digite o numero de telefone"></div>
          <div class="field"><label>Mensagem</label><textarea id="messagesendtext"></textarea></div>
        </div>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
        <div class="ui positive right labeled icon button">Enviar<i class="checkmark icon"></i></div>
      </div>
    </div>

     <div class="ui modal" id="modalDeleteMessage"><i class="close icon"></i>
      <div class="header"> Apagar Mensagem </div>
      <div class="content">
        <div class="ui message info hidden" id="deleteMessageContainer"></div>
        <div class="ui form">
          <div class="field"><label>Telefone</label><input id="messagedeletephone" type="text" placeholder="Digite o numero de telefone"></div>
          <div class="field"><label>ID da Mensagem</label><input id="messagedeleteid" type="text" placeholder="Digite o ID da mensagem"></div>
        </div>
      </div>
      <div class="actions">
        <div class="ui cancel button">Fechar</div>
        <div class="ui positive right labeled icon button">Apagar<i class="trash icon"></i></div>
      </div>
    </div>

   
  </div>
<script>

  let baseUrl = window.location.origin;
  let scanned = false;

  async function wait(time) {
    return new Promise(resolve => {
      setTimeout(() => {
        resolve();
      }, time);
    });
  }

  document.addEventListener('DOMContentLoaded', function() {

    hideWidgets();

    const authTokenInput = document.getElementById('authtoken');
    authTokenInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const token = authTokenInput.value.trim();
        if (token) {
          const url = new URL(window.location.href);
          url.searchParams.set('token', token);
          window.location.href = url.toString();
        }
      }
    });

    const pairPhoneInput = document.getElementById('pairphoneinput');
    pairPhoneInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const phone = pairPhoneInput.value.trim();
        if (phone) {
          connect().then((data) => {
            if(data.success==true) {
              pairPhone(phone)
                .then((data) => {
                  document.getElementById('pairHelp').classList.add('hidden');;
                  // Success case
                  if (data.success && data.data && data.data.LinkingCode) {
                    document.getElementById('pairInfo').innerHTML = `Seu codigo de pareamento e: ${data.data.LinkingCode}`;
                    scanInterval = setInterval(checkStatus, 1000);
                  } else {
                    document.getElementById('pairInfo').innerHTML = "Problema ao obter o codigo de pareamento";
                  }
                })
                .catch((error) => {
                  // Error case
                  document.getElementById('pairInfo').innerHTML = "Problema ao obter o codigo de pareamento";
                  console.error('Erro de pareamento:', error);
                });
            }
          });
        }
      }
    });

    const userInfoInput = document.getElementById('userinfoinput');
    userInfoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        doUserInfo();
      }
    });
 
    const userAvatarInput = document.getElementById('useravatarinput');
    userAvatarInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        doUserAvatar();
      }
    });
 
    document.getElementById('logoutWidget').addEventListener('click', function() {
      logout().then(function() { window.location.reload();});
    });

    document.getElementById('loginQR').addEventListener('click', function() {
      QRLogin();
    });

    document.getElementById('authWidget').addEventListener('click', function() {
      $('#modalAuthenticate').modal({closable:false}).modal('show');
    });

    document.getElementById('loginCode').addEventListener('click', function() {
      $('#modalLoginWithCode').modal({
        onVisible: function() {
          document.getElementById('pairInfo').classList.remove('hidden');;
          document.getElementById('pairHelp').classList.remove('hidden');;
        },
        onHidden: function() {
          if(scanned==true) {
              document.getElementById('loginQR').classList.add('hidden');
              document.getElementById('loginCode').classList.add('hidden');
              document.getElementById('logoutWidget').classList.remove('hidden');
          }
        }
      })
      .modal('show');
    });
  
    document.getElementById('userInfo').addEventListener('click', function() {
      document.getElementById('userInfoContainer').innerHTML='';
      document.getElementById("userInfoContainer").classList.add('hidden');
      $('#modalUserInfo').modal({onApprove: function() {
        doUserInfo();
        return false;
      }}).modal('show');
    });
  
    document.getElementById('userAvatar').addEventListener('click', function() {
      document.getElementById('userAvatarContainer').innerHTML='';
      document.getElementById("userAvatarContainer").classList.add('hidden');
      $('#modalUserAvatar').modal({onApprove: function() {
        doUserAvatar();
        return false;
      }}).modal('show');
    });
 
    document.getElementById('sendTextMessage').addEventListener('click', function() {
      document.getElementById('sendMessageContainer').innerHTML='';
      document.getElementById("sendMessageContainer").classList.add('hidden');
      $('#modalSendTextMessage').modal({onApprove: function() {
        sendTextMessage().then((result)=>{
          document.getElementById("sendMessageContainer").classList.remove('hidden');
          if(result.success===true) {
             document.getElementById('sendMessageContainer').innerHTML=`Mensagem enviada com sucesso. Id: ${result.data.Id}`
          } else {
             document.getElementById('sendMessageContainer').innerHTML=`Problema ao enviar mensagem: ${result.error}`
          }
        });
        return false;
      }}).modal('show');
    });
 
    document.getElementById('deleteMessage').addEventListener('click', function() {
      document.getElementById('deleteMessageContainer').innerHTML='';
      document.getElementById("deleteMessageContainer").classList.add('hidden');
      $('#modalDeleteMessage').modal({onApprove: function() {
        deleteMessage().then((result)=>{
          console.log(result);
          document.getElementById("deleteMessageContainer").classList.remove('hidden');
          if(result.success===true) {
             document.getElementById('deleteMessageContainer').innerHTML=`Mensagem apagada com sucesso.`
          } else {
             document.getElementById('deleteMessageContainer').innerHTML=`Problema ao apagar mensagem: ${result.error}`
          }
        });
        return false;
      }}).modal('show');
    });
  
    document.getElementById('userContacts').addEventListener('click', function() {
      getContacts();
    });

    document.getElementById('getWebhook').addEventListener('click', function() {
      getWebhook();
    });

    document.getElementById('deleteWebhook').addEventListener('click', function() {
    $('#modalDeleteWebhook')
      .modal({
        closable: true,
        onDeny: function(){
          return true;
        },
        onApprove: function() {
          deleteWebhook().then((response)=>{
            if(response.success==true) {
              $.toast({ class: 'success', message: `Webhook removido com sucesso!` });
            } else {
              $.toast({ class: 'error', message: `Nao foi possivel remover o webhook! ${response.error}` });
            }
          });
        }
      })
      .modal('show');
    });
    document.getElementById('setWebhook').addEventListener('click', function() {
      $('#modalSetWebhook').modal({onApprove: function() {
        setWebhook().then((result)=>{
          if(result.success===true) {
             $.toast({ class: 'success', message: `Webhook configurado com sucesso!`});
          } else {
        $.toast({ class: 'error', message: `Problema ao configurar webhook: ${result.error}`});
          }
        });
        return true;
      }}).modal('show');
    });

 
  });

  async function sendTextMessage() {
    const sendPhone = document.getElementById('messagesendphone').value.trim();
    const sendBody = document.getElementById('messagesendtext').value;
    const myHeaders = new Headers();
    const uuid = generateMessageUUID();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/chat/send/text", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Phone: sendPhone, Body: sendBody, Id: uuid})
    });
    data = await res.json();
    return data;
  }
 
  async function deleteMessage() {
    const deletePhone = document.getElementById('messagedeletephone').value.trim();
    const deleteId = document.getElementById('messagedeleteid').value;
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/chat/delete", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Phone: deletePhone, Id: deleteId})
    });
    data = await res.json();
    return data;
  }
 
  async function setWebhook() {
    const webhook = document.getElementById('webhookinput').value.trim();
    const events = $('#webhookEvents').dropdown('get value')
    if (events.includes("All")) {
      events.length = 0;
      events.push("All");
    }
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/webhook", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({WebhookURL: webhook, events: events})
    });
    data = await res.json();
    return data;
  }
 
  async function deleteWebhook() {
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/webhook", {
      method: "DELETE",
      headers: myHeaders
    });
    data = await res.json();
    return data;
  }
 
  function doUserAvatar() {
    const userAvatarInput = document.getElementById('useravatarinput');
    let phone = userAvatarInput.value.trim();
    if (phone) {
      if (!phone.endsWith('@s.whatsapp.net')) {
        phone = phone.includes('@') ? phone.split('@')[0] + '@s.whatsapp.net' : phone + '@s.whatsapp.net';
      }
      userAvatar(phone).then((data) => {
        document.getElementById("userAvatarContainer").classList.remove('hidden');
        if (data.success && data.data && data.data.url) {
          const userAvatarDiv = document.getElementById('userAvatarContainer');
          userAvatarDiv.innerHTML=`<img src="${data.data.url}" alt="Profile Picture" class="user-avatar">`;
        } else {
            document.getElementById('userAvatarContainer').innerHTML = 'Nenhum avatar encontrado';
        }
      }).catch(error => {
        document.getElementById('userAvatarContainer').innerHTML = 'Erro ao buscar avatar';
        console.error('Error:', error);
      });
    }
  } 

  function doUserInfo() {
    const userInfoInput = document.getElementById('userinfoinput');
    let phone = userInfoInput.value.trim();
    if (phone) {
      if (!phone.endsWith('@s.whatsapp.net')) {
        phone = phone.includes('@') ? phone.split('@')[0] + '@s.whatsapp.net' : phone + '@s.whatsapp.net';
      }
      userInfo(phone).then((data) => {
        document.getElementById("userInfoContainer").classList.remove('hidden');
        if (data.success && data.data && data.data.Users) {
            // Clear previous results
            const userInfoDiv = document.getElementById('userInfoContainer');
            userInfoDiv.innerHTML = '';
            
            // Loop through each user
            for (const [userJid, userData] of Object.entries(data.data.Users)) {
                const userElement = document.createElement('div');
                userElement.className = 'user-entry';
                
                // Display phone number (extracted from JID)
                const phoneNumber = userJid.split('@')[0];
                userElement.innerHTML += `<strong>Telefone: ${phoneNumber}</strong><br>`;
                
                // Display Status if available
                userElement.innerHTML += `Status: ${userData.Status || 'Nao disponivel'}<br>`;
                
                // Display VerifiedName if available
                userElement.innerHTML += `Nome verificado: ${userData.VerifiedName || 'Nao verificado'}<br>`;
                
                // Add device count if available
              if (userData.Devices && userData.Devices.length > 0) {
                    userElement.innerHTML += `Dispositivos: ${userData.Devices.length}<br>`;
                }
                
                userInfoDiv.appendChild(userElement);
            }
        } else {
            document.getElementById('userInfoContainer').innerHTML = 'Nenhum dado encontrado';
        }
      }).catch(error => {
        document.getElementById('userInfoContainer').innerHTML = 'Erro ao buscar informacoes do usuario';
        console.error('Error:', error);
      });
    }
  }

  function QRLogin() {
    $('#modalLoginQR').modal({
    onVisible: function () {
      connect().then((data) => {
        if(data.success==true) {
          showQr();
        } else {
          document.getElementById("incorrectstatus").innerHTML = "Nao foi possivel conectar";
          document.getElementById('loginQR').classList.remove('hidden');
          document.getElementById('loginCode').classList.remove('hidden');
        }
      }); 
    },
    onHidden: function() {
      console.log("QR modal hidden");
      if(scanned==true) {
          document.getElementById('loginQR').classList.add('hidden');
          document.getElementById('loginCode').classList.add('hidden');
          document.getElementById('logoutWidget').classList.remove('hidden');
      } else {
          clearInterval(scanInterval);
      }
    }
    }).modal('show');
  }

  function showWidgets() {
    document.querySelectorAll('.widget').forEach(widget => {
      widget.classList.remove('hidden');
    });
  }

  function hideWidgets() {
    document.querySelectorAll('.widget').forEach(widget => {
      widget.classList.add('hidden');
    });
  }

  function checkStatus() {
    console.log("checkStatus");
    statusRequest().then((status) => {
      if(status.success==true) {
        if(status.data.LoggedIn === true) {
          scanned = true;
          document.getElementById("connectstatus").innerHTML = "Conectado!";
          document.getElementById("connectstatus").classList.remove('red');
          document.getElementById("connectstatus").classList.add('green');
          document.getElementById("connectstatus").classList.remove('hidden');
          clearInterval(scanInterval);
          showWidgets();

          $('#modalLoginQR').modal('hide');
          $('#modalLoginWithCode').modal('hide');

        }
      } else {
        clearInterval(scanInterval);
      }
    });
  }

  async function showQr() {
    console.log('showqr');
    QRLogin();
    clearInterval(scanInterval);
    scanInterval = setInterval(checkStatus, 1000);
    console.log("showQr");
    while (!scanned) {
      console.log("not scanned");
      if (!$('#modalLoginQR').is(':visible')) { console.log("qr modal closed, do nothing"); return; }
      var qrData = await getQr();
      if(qrData.success==true) {
        var qrString = qrData.data.QRCode;
        var image = document.createElement("img");
        var imageContainer = document.getElementById("qrContainer");
    
        image.id = "qrcode";
        image.src = qrString;
        imageContainer.innerHTML = "";
        imageContainer.appendChild(image);
			if(qrData.data.QRCode != "") {
              console.log('wait 15 seconds to scan');
              await wait(15 * 1000);
            }
      } else {
        scanned = true;
        clearInterval(scanInterval);
        document.getElementById("connectstatus").innerHTML = "Tempo esgotado! Tente novamente quando estiver pronto para escanear o codigo QR";
        $('#modalLoginQR').modal('hide');
      }
    }
  }

  async function connect() {
    console.log("Connecting...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/session/connect", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Events: 'All', Immediate: true})
    });
    data = await res.json();
    return data;
  }

  async function disconnect() {
    console.log("Disconnecting...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/session/disconnect", {
      method: "POST",
      headers: myHeaders,
    });
    data = await res.json();
    return data;
  }

  async function status() {
    console.log("Get status...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/session/status", {
      method: "GET",
      headers: myHeaders
    });
    data = await res.json();
    return data;
  }

  async function getWebhook() {
    console.log("Getting webhook...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    try {
      const res = await fetch(baseUrl + "/webhook", {
        method: "GET",
        headers: myHeaders,
      });
      data = await res.json();
      let webhook = '';
      let events = '';
      if (data.code === 200) {
         webhook = data.data.webhook
         events = data.data.subscribe.join(",")
      } else {
         webhook = `Problema ao obter webhook: ${error}`
      }
      $('#modalGetWebhook').modal('show');
      document.getElementById('getWebhookContainer').innerHTML=webhook;
      document.getElementById('getWebhookContainerEvents').innerHTML=events;
    } catch (error) {
      console.error("Error fetching webhook:", error);
      throw error;
    }
  }

  async function getContacts() {
    console.log("Getting contacts...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    try {
      const res = await fetch(baseUrl + "/user/contacts", {
        method: "GET",
        headers: myHeaders,
      });
      data = await res.json();
      if (data.code === 200) {
        const transformedContacts = Object.entries(data.data).map(([phone, contact]) => ({
            FullName: contact.FullName || "",
            PushName: contact.PushName || "",
            Phone: phone.split('@')[0] // Remove the @s.whatsapp.net part
        }));
        downloadJson(transformedContacts, 'contacts.json');
        return transformedContacts;
      } else {
        throw new Error(`API returned code ${data.code}`);
      }
    } catch (error) {
      console.error("Error fetching contacts:", error);
      throw error;
    }
  }

  async function userAvatar(phone) {
    console.log("Requesting user avatar...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/user/avatar", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Phone: phone, Preview: false})
    });
    data = await res.json();
    return data;
  }
 
  async function userInfo(phone) {
    console.log("Requesting user info...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/user/info", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Phone: [phone]})
    });
    data = await res.json();
    return data;
  }

  async function pairPhone(phone) {
    console.log("Requesting pairing code...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/session/pairphone", {
      method: "POST",
      headers: myHeaders,
      body: JSON.stringify({Phone: phone})
    });
    data = await res.json();
    return data;
  }

  async function logout() {
    console.log("Login out...");
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    myHeaders.append('Content-Type', 'application/json');
    res = await fetch(baseUrl + "/session/logout", {
      method: "POST",
      headers: myHeaders,
    });
    data = await res.json();
    return data;
  }

  async function getQr() {
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    res = await fetch(baseUrl + "/session/qr", {
      method: "GET",
      headers: myHeaders,
    });
    data = await res.json();
    return data;
  }

  async function statusRequest() {
    const myHeaders = new Headers();
    myHeaders.append('token', token);
    res = await fetch(baseUrl + "/session/status", {
      method: "GET",
      headers: myHeaders,
    });
    data = await res.json();
    return data;
  }

  function parseURLParams(url) {
    var queryStart = url.indexOf("?") + 1,
        queryEnd   = url.indexOf("#") + 1 || url.length + 1,
        query = url.slice(queryStart, queryEnd - 1),
        pairs = query.replace(/\+/g, " ").split("&"),
        parms = {}, i, n, v, nv;

    if (query === url || query === "") return;
      for (i = 0; i < pairs.length; i++) {
        nv = pairs[i].split("=", 2);
        n = decodeURIComponent(nv[0]);
        v = decodeURIComponent(nv[1]);
        if (!parms.hasOwnProperty(n)) parms[n] = [];
        parms[n].push(nv.length === 2 ? v : null);
    }
    return parms;
  }

  function downloadJson(data, filename) {
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
  }
 
  function generateMessageUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
 
  // Starting
  let notoken=0;
  let token="";
  let scanInterval;
  let param = parseURLParams(window.location.href);

  if(param!=undefined) {
    if(param["token"]===undefined) {
      notoken=1;
    }
  } else {
    notoken=1;
  }

  if(notoken==1) {
    document.getElementById("connectstatus").innerHTML = "Nenhum token de autenticacao informado";
    $('#modalAuthenticate').modal({closable:false}).modal('show');
  } else {

    token = param["token"][0];

    statusRequest().then((status) => {
      if(status.success==true) {
          if(status.data.LoggedIn === false) {
              if(status.data.Connected === true) {
                  showQr();
              } else {
                  console.log("Not connected, attempting to connect.");
                  connect().then((data) => {console.log("promise connect 1"); console.log(data);});
              }
          } else {
              if(status.data.Connected === false) {
                  connect().then((data) => {console.log("promise connect 2"); console.log(data);});
              }
              document.getElementById("connectstatus").innerHTML = "Conectado!";
              document.getElementById("connectstatus").classList.remove('red');
              document.getElementById("connectstatus").classList.add('green');
              document.getElementById("connectstatus").classList.remove('hidden');
              document.getElementById('logoutWidget').classList.remove('hidden');
              document.getElementById('loginQR').classList.add('hidden');
              document.getElementById('loginCode').classList.add('hidden');
              scanned = true;
              showWidgets();
          }
      } else if(status.success==false) {
          if(status.error=="No session") {
              document.getElementById('loginQR').classList.remove('hidden');
              document.getElementById('loginCode').classList.remove('hidden');
              document.getElementById('connectstatus').classList.add('hidden');
          } else if(status.error=="Unauthorized") {
              document.getElementById("incorrectstatus").innerHTML = `Autenticacao invalida`;
              document.getElementById("connectstatus").innerHTML = "Token invalido";
              document.getElementById('connectstatus').classList.remove('hidden');
              document.getElementById('invalidCredentials').classList.remove('hidden');
              $('#modalAuthenticate').modal({closable:false}).modal('show');
          }
      } else {
          document.getElementById("connectstatus").innerHTML = `Falha de autenticacao ${status.Status}`;
          document.getElementById('connectstatus').classList.remove('hidden');
      }
      return;
    });
}

$(document).ready(function() {
  $('#webhookEvents').dropdown({
    onChange: function(value, text, $selectedItem) {
      if (value.includes('All')) {
        // If "All" is selected, select all other options
        $('#webhookEvents').dropdown('set selected', [
          'Message', 
          'ReadReceipt', 
          'Presence', 
          'HistorySync', 
          'ChatPresence', 
          'All'
        ]);
      }
    }
  });
});

</script>
</body>
</html>
